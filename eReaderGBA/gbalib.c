#include <stdint.h>
#include <stddef.h>
#include <string.h>
#include "gbalib.h"
#ifdef EREADER
#include "def.h"
#include "erapi.h"
static ERAPI_HANDLE_REGION region;
#endif

uint16_t *fb = (void*)0x6000000;
uint16_t *pal_register = (void*)0x5000000;

uint16_t prevButtons = ~0;
uint16_t currButtons = ~0;

unsigned char std_font[];

void Init_GBA(uint8_t mode)
{
#ifdef EREADER
	extern int __end[];
	// init
	ERAPI_FadeIn(1);
	ERAPI_InitMemory( (ERAPI_RAM_END - (u32)__end) >> 10);
	ERAPI_SetBackgroundMode(0);
	// palette
	//ERAPI_SetBackgroundPalette( &palette[0], 0x00, 0x02);
	// region & text
	//region = ERAPI_CreateRegion( 0, 0, 0x01, 0x01, 0x1C, 0x03);
	//ERAPI_SetTextColor( region, 0x01, 0x00);
	//ERAPI_DrawText( region, 0x50, 0x08, "Sex");
	// background
	ERAPI_LoadBackgroundSystem( 3, 2);
	//ERAPI_SetBackgroundAutoScroll( 3, 0x40, 0x40);
#endif

	static volatile uint16_t * const reg_disp_ctl = (void*)0x4000000;
	static volatile uint16_t * const bg0_disp_ctl = (void*)0x4000008;
	*reg_disp_ctl = mode | BG2_ENABLE;
	*reg_disp_ctl &= ~FRAME_SEL_BIT;
#if 0
	switch(mode)
	{
		case 0:
		case 1:
		case 2:
			*bg0_disp_ctl = BG_COLOR16 | TEXTBG_SIZE_256x256 | (31 << SCREEN_SHIFT) | WRAPAROUND;
			*reg_disp_ctl =  mode | BG0_ENABLE;
		break;
		default:
			*reg_disp_ctl = mode | BG2_ENABLE;
			*reg_disp_ctl &= ~FRAME_SEL_BIT;
		break;
	}
#endif
}


/*
void DMAFastCopy(void* source, void* dest, unsigned int count, unsigned int mode)
{
	if (mode == DMA_16NOW || mode == DMA_32NOW)
	{
		REG_DMA3SAD = (unsigned int) source;
		REG_DMA3DAD = (unsigned int) dest;
		REG_DMA3CNT = count | mode;
	}
}
*/

static inline void drawChar(char ch, uint8_t x, uint8_t y, uint8_t color_index, uint8_t bg)
{
    unsigned char i, j;
    unsigned char *charSprite;
    
    //if (ch < 33 || ch > 122) return;
    
    ch -= 33;
    charSprite = ((ch) << 3) + std_font;

	uint16_t *base = &fb[(y * M4_WIDTH) >> 1];
    // Draw charSprite as monochrome 8*8 image using given color
    for (j = 0; j < 8; j += 2)
    {
        uint16_t *line = base + ((x + j) >> 1);
        uint8_t bit1 = 7 - j;
        uint8_t bit2 = bit1 - 1;
        for (i = 0; i < 8; i++)
        {
            uint8_t clrid1 = ((charSprite[i] >> bit1) & 1) ? color_index : bg;
            uint8_t clrid2 = ((charSprite[i] >> bit2) & 1) ? color_index : bg;
            line[(i << 7) - (i << 3)] = clrid1 | (clrid2 << 8);
        }
    }
}


void Draw_Text(const char* str, uint8_t x, uint8_t y, uint8_t color_index, uint8_t bg)
{
	//ERAPI_DrawText( region, 0x50, 0x08, "Sex");
	uint8_t i;
	for(i = 0; str[i]; i++)
	{
		drawChar(str[i], x + (i << 3), y, color_index, bg);
	}
}

void Draw_Text_Center(const char* str, uint8_t y, uint8_t color_index, uint8_t bg)
{
	uint8_t x;
	x = (240 - (strlen(str) << 3)) >> 1;
	
	Draw_Text(str, x, y, color_index, bg);
}

/*
void *memset16(void *dst, int val, size_t count) {
    uint16_t *dst16 = (uint16_t*)dst;
    uint16_t val16 = (uint16_t)val;
    while (count--) {
        *dst16++ = val16;
    }
    return dst;
}*/

unsigned char std_font[] = /* NSDL_FONT_VGA */
{
	0x30, 0x78, 0x78, 0x30, 0x30, 0x00, 0x30, 0x00, // Char 033 (!)
	0x6C, 0x6C, 0x6C, 0x00, 0x00, 0x00, 0x00, 0x00, // Char 034 (")
	0x6C, 0x6C, 0xFE, 0x6C, 0xFE, 0x6C, 0x6C, 0x00, // Char 035 (#)
	0x30, 0x7C, 0xC0, 0x78, 0x0C, 0xF8, 0x30, 0x00, // Char 036 ($)
	0x00, 0xC6, 0xCC, 0x18, 0x30, 0x66, 0xC6, 0x00, // Char 037 (%)
	0x38, 0x6C, 0x38, 0x76, 0xDC, 0xCC, 0x76, 0x00, // Char 038 (&)
	0x60, 0x60, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, // Char 039 (')
	0x18, 0x30, 0x60, 0x60, 0x60, 0x30, 0x18, 0x00, // Char 040 (()
	0x60, 0x30, 0x18, 0x18, 0x18, 0x30, 0x60, 0x00, // Char 041 ())
	0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00, // Char 042 (*)
	0x00, 0x30, 0x30, 0xFC, 0x30, 0x30, 0x00, 0x00, // Char 043 (+)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x60, // Char 044 (,)
	0x00, 0x00, 0x00, 0xFC, 0x00, 0x00, 0x00, 0x00, // Char 045 (-)
	0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x00, // Char 046 (.)
	0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0x80, 0x00, // Char 047 (/)
	0x7C, 0xC6, 0xCE, 0xDE, 0xF6, 0xE6, 0x7C, 0x00, // Char 048 (0)
	0x30, 0x70, 0x30, 0x30, 0x30, 0x30, 0xFC, 0x00, // Char 049 (1)
	0x78, 0xCC, 0x0C, 0x38, 0x60, 0xCC, 0xFC, 0x00, // Char 050 (2)
	0x78, 0xCC, 0x0C, 0x38, 0x0C, 0xCC, 0x78, 0x00, // Char 051 (3)
	0x1C, 0x3C, 0x6C, 0xCC, 0xFE, 0x0C, 0x1E, 0x00, // Char 052 (4)
	0xFC, 0xC0, 0xF8, 0x0C, 0x0C, 0xCC, 0x78, 0x00, // Char 053 (5)
	0x38, 0x60, 0xC0, 0xF8, 0xCC, 0xCC, 0x78, 0x00, // Char 054 (6)
	0xFC, 0xCC, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x00, // Char 055 (7)
	0x78, 0xCC, 0xCC, 0x78, 0xCC, 0xCC, 0x78, 0x00, // Char 056 (8)
	0x78, 0xCC, 0xCC, 0x7C, 0x0C, 0x18, 0x70, 0x00, // Char 057 (9)
	0x00, 0x30, 0x30, 0x00, 0x00, 0x30, 0x30, 0x00, // Char 058 (:)
	0x00, 0x30, 0x30, 0x00, 0x00, 0x30, 0x30, 0x60, // Char 059 (;)
	0x18, 0x30, 0x60, 0xC0, 0x60, 0x30, 0x18, 0x00, // Char 060 (<)
	0x00, 0x00, 0xFC, 0x00, 0x00, 0xFC, 0x00, 0x00, // Char 061 (=)
	0x60, 0x30, 0x18, 0x0C, 0x18, 0x30, 0x60, 0x00, // Char 062 (>)
	0x78, 0xCC, 0x0C, 0x18, 0x30, 0x00, 0x30, 0x00, // Char 063 (?)
	0x7C, 0xC6, 0xDE, 0xDE, 0xDE, 0xC0, 0x78, 0x00, // Char 064 (@)
	0x30, 0x78, 0xCC, 0xCC, 0xFC, 0xCC, 0xCC, 0x00, // Char 065 (A)
	0xFC, 0x66, 0x66, 0x7C, 0x66, 0x66, 0xFC, 0x00, // Char 066 (B)
	0x3C, 0x66, 0xC0, 0xC0, 0xC0, 0x66, 0x3C, 0x00, // Char 067 (C)
	0xF8, 0x6C, 0x66, 0x66, 0x66, 0x6C, 0xF8, 0x00, // Char 068 (D)
	0xFE, 0x62, 0x68, 0x78, 0x68, 0x62, 0xFE, 0x00, // Char 069 (E)
	0xFE, 0x62, 0x68, 0x78, 0x68, 0x60, 0xF0, 0x00, // Char 070 (F)
	0x3C, 0x66, 0xC0, 0xC0, 0xCE, 0x66, 0x3E, 0x00, // Char 071 (G)
	0xCC, 0xCC, 0xCC, 0xFC, 0xCC, 0xCC, 0xCC, 0x00, // Char 072 (H)
	0x78, 0x30, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00, // Char 073 (I)
	0x1E, 0x0C, 0x0C, 0x0C, 0xCC, 0xCC, 0x78, 0x00, // Char 074 (J)
	0xE6, 0x66, 0x6C, 0x78, 0x6C, 0x66, 0xE6, 0x00, // Char 075 (K)
	0xF0, 0x60, 0x60, 0x60, 0x62, 0x66, 0xFE, 0x00, // Char 076 (L)
	0xC6, 0xEE, 0xFE, 0xFE, 0xD6, 0xC6, 0xC6, 0x00, // Char 077 (M)
	0xC6, 0xE6, 0xF6, 0xDE, 0xCE, 0xC6, 0xC6, 0x00, // Char 078 (N)
	0x38, 0x6C, 0xC6, 0xC6, 0xC6, 0x6C, 0x38, 0x00, // Char 079 (O)
	0xFC, 0x66, 0x66, 0x7C, 0x60, 0x60, 0xF0, 0x00, // Char 080 (P)
	0x78, 0xCC, 0xCC, 0xCC, 0xDC, 0x78, 0x1C, 0x00, // Char 081 (Q)
	0xFC, 0x66, 0x66, 0x7C, 0x6C, 0x66, 0xE6, 0x00, // Char 082 (R)
	0x78, 0xCC, 0xE0, 0x70, 0x1C, 0xCC, 0x78, 0x00, // Char 083 (S)
	0xFC, 0xB4, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00, // Char 084 (T)
	0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xFC, 0x00, // Char 085 (U)
	0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x78, 0x30, 0x00, // Char 086 (V)
	0xC6, 0xC6, 0xC6, 0xD6, 0xFE, 0xEE, 0xC6, 0x00, // Char 087 (W)
	0xC6, 0xC6, 0x6C, 0x38, 0x38, 0x6C, 0xC6, 0x00, // Char 088 (X)
	0xCC, 0xCC, 0xCC, 0x78, 0x30, 0x30, 0x78, 0x00, // Char 089 (Y)
	0xFE, 0xC6, 0x8C, 0x18, 0x32, 0x66, 0xFE, 0x00, // Char 090 (Z)


};
